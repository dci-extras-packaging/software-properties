From: Matthias Klumpp <mak@debian.org>
Date: Sun, 13 Mar 2016 16:15:55 +0100
Subject: Handle error condition on cache refresh better

---
 softwareproperties/gtk/DialogCacheOutdated.py   | 9 +++++----
 softwareproperties/gtk/SoftwarePropertiesGtk.py | 9 +++++----
 softwareproperties/kde/SoftwarePropertiesKDE.py | 9 +++++----
 3 files changed, 15 insertions(+), 12 deletions(-)

diff --git a/softwareproperties/gtk/DialogCacheOutdated.py b/softwareproperties/gtk/DialogCacheOutdated.py
index 83b9740..a1d7c05 100644
--- a/softwareproperties/gtk/DialogCacheOutdated.py
+++ b/softwareproperties/gtk/DialogCacheOutdated.py
@@ -81,12 +81,13 @@ class DialogCacheOutdated:
             self._pdia.progressbar.set_fraction(perc / 100.0)
 
     def on_pktask_finish(self, source, result, udata=(None,)):
-        results = self._pktask.generic_finish(result)
-        error = results.get_error_code()
-        if error != None:
+        results = None
+        try:
+            results = self._pktask.generic_finish(result)
+        except Exception as e:
             dialog = Gtk.MessageDialog(self, 0, Gtk.MessageType.ERROR,
                 Gtk.ButtonsType.CANCEL, _("Error while refreshing cache"))
-            dialog.format_secondary_text(error.get_details())
+            dialog.format_secondary_text(str(e))
             dialog.run()
         self._loop.quit ()
 
diff --git a/softwareproperties/gtk/SoftwarePropertiesGtk.py b/softwareproperties/gtk/SoftwarePropertiesGtk.py
index fab34bc..df8ad45 100644
--- a/softwareproperties/gtk/SoftwarePropertiesGtk.py
+++ b/softwareproperties/gtk/SoftwarePropertiesGtk.py
@@ -1053,13 +1053,14 @@ class SoftwarePropertiesGtk(SoftwareProperties, SimpleGtkbuilderApp):
             self.progress_bar.set_fraction(prog_value / 100.0)
 
     def on_driver_changes_finish(self, source, result, installs_pending):
-        results = self.pk_task.generic_finish(result)
-        error = results.get_error_code()
-        if error != None:
+        results = None
+        try:
+            results = self.pk_task.generic_finish(result)
+        except Exception as e:
             self.on_driver_changes_revert()
             dialog = Gtk.MessageDialog(self, 0, Gtk.MessageType.ERROR,
                 Gtk.ButtonsType.CANCEL, _("Error while applying changes"))
-            dialog.format_secondary_text(error.get_details())
+            dialog.format_secondary_text(str(e))
             dialog.run()
         if not installs_pending:
             self.progress_bar.set_visible(False)
diff --git a/softwareproperties/kde/SoftwarePropertiesKDE.py b/softwareproperties/kde/SoftwarePropertiesKDE.py
index e3173be..f31474c 100644
--- a/softwareproperties/kde/SoftwarePropertiesKDE.py
+++ b/softwareproperties/kde/SoftwarePropertiesKDE.py
@@ -703,10 +703,11 @@ class SoftwarePropertiesKDE(SoftwareProperties):
       self._pdialog.setValue(perc)
 
   def on_pktask_finish(self, source, result, udata=(None,)):
-    results = self._pktask.generic_finish(result)
-    error = results.get_error_code()
-    if error != None:
-      QMessageBox.warning(self.userinterface, _("Could not refresh cache"), error.get_details())
+    results = None
+    try:
+        results = self._pktask.generic_finish(result)
+    except Exception as e:
+      QMessageBox.warning(self.userinterface, _("Could not refresh cache"), str(e))
     self._pdialog.hide()
     kapp.quit()
 
